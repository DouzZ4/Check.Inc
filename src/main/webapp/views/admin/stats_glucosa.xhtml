<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:p="http://primefaces.org/ui" lang="es">

<h:head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gesti칩n y An치lisis de Glucosa - Admin</title>
    <h:outputStylesheet library="css" name="navbar.css" />
    <h:outputStylesheet library="css" name="styles.css" />
    <h:outputStylesheet library="css" name="glucose.css" />

    <!-- DataTables CSS/JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css" />
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>

    <style>
        .stats-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .filter-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .chart-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .table-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            border-left: 5px solid;
        }

        .kpi-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
            display: block;
        }

        .kpi-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .kpi-normal {
            border-color: #38a169;
        }

        .kpi-normal .kpi-value {
            color: #38a169;
        }

        .kpi-warning {
            border-color: #dd6b20;
        }

        .kpi-warning .kpi-value {
            color: #dd6b20;
        }

        .kpi-danger {
            border-color: #e53e3e;
        }

        .kpi-danger .kpi-value {
            color: #e53e3e;
        }

        .kpi-info {
            border-color: #3058a6;
        }

        .kpi-info .kpi-value {
            color: #3058a6;
        }

        .conclusion-box {
            background-color: #ebf8ff;
            border-left: 4px solid #3058a6;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            font-size: 1.1em;
            color: #2c5282;
        }

        /* Estilos Badge Tabla */
        .badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.85em;
            display: inline-block;
            min-width: 70px;
            text-align: center;
        }

        .badge-alto {
            background-color: #fbd38d;
            color: #9c4221;
        }

        .badge-normal {
            background-color: #c6f6d5;
            color: #276749;
        }

        .badge-bajo {
            background-color: #fed7d7;
            color: #c53030;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            background: #e2e8f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4a5568;
            font-weight: bold;
            font-size: 0.8em;
        }

        /* DataTables Header Override */
        table.dataTable thead th {
            background-color: #3058a6;
            color: white;
            border-bottom: none;
        }

        body .ui-selectonemenu {
            width: 100%;
            max-width: 300px;
        }
    </style>
    <link rel="shortcut icon" href="#{resource['images:ICONO.png']}" />

    <script type="text/javascript">
        // Funci칩n para inicializar/reinicializar DataTables despu칠s de AJAX
        function initTable() {
            if ($.fn.DataTable.isDataTable('#registrosTable')) {
                $('#registrosTable').DataTable().destroy();
            }
            $('#registrosTable').DataTable({
                "language": { "url": "https://cdn.datatables.net/plug-ins/1.11.3/i18n/es_es.json" },
                "pageLength": 10,
                "responsive": true,
                "order": [[2, "desc"]]
            });
        }

        $(document).ready(function () {
            initTable();
        });
    </script>
</h:head>

<h:body>
    <ui:include src="/includes/navbar.xhtml" />

    <main class="stats-container">
        <div class="header-section"
            style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>游늵 Gesti칩n de Glucosa</h1>
                <p>An치lisis visual e historial detallado de pacientes.</p>
            </div>
            <h:button value="Volver al Panel" outcome="/views/inicioGestion.xhtml"
                styleClass="action-button cancel-button" />
        </div>

        <h:form id="statsForm">
            <!-- Filtros -->
            <div class="filter-card">
                <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;">
                    <div style="flex: 1; min-width: 250px;">
                        <h:outputLabel value="Seleccionar Paciente:" for="paciente"
                            style="display: block; margin-bottom: 8px; font-weight: bold;" />
                        <p:selectOneMenu id="paciente" value="#{statsGlucosaBean.pacienteSeleccionado}" filter="true"
                            filterMatchMode="contains" style="width: 100%;">
                            <f:selectItem itemLabel="Todos los pacientes" itemValue="0" />
                            <f:selectItems value="#{statsGlucosaBean.pacientes}" var="p"
                                itemLabel="#{p.nombres} #{p.apellidos} (#{p.documento})" itemValue="#{p.idUsuario}" />
                            <p:ajax listener="#{statsGlucosaBean.onPacienteChange}"
                                update="chartPanel kpiPanel conclusionPanel tablePanel" oncomplete="initTable()" />
                        </p:selectOneMenu>
                    </div>

                    <div style="flex: 1; min-width: 200px;">
                        <h:outputLabel value="Per칤odo:" for="periodo"
                            style="display: block; margin-bottom: 8px; font-weight: bold;" />
                        <p:selectOneMenu id="periodo" value="#{statsGlucosaBean.rangoPeriodo}" style="width: 100%;">
                            <f:selectItem itemLabel="Hist칩rico Completo" itemValue="todos" />
                            <f:selectItem itemLabel="칔ltima Semana" itemValue="semana" />
                            <f:selectItem itemLabel="칔ltimo Mes" itemValue="mes" />
                            <p:ajax listener="#{statsGlucosaBean.onPeriodoChange}"
                                update="chartPanel kpiPanel conclusionPanel tablePanel" oncomplete="initTable()" />
                        </p:selectOneMenu>
                    </div>
                </div>
            </div>

            <!-- KPIs -->
            <h:panelGroup id="kpiPanel" layout="block" styleClass="kpi-grid">
                <div class="kpi-card kpi-info">
                    <span class="kpi-value">#{statsGlucosaBean.estadisticas.promedio}</span>
                    <span class="kpi-label">Promedio (mg/dL)</span>
                </div>
                <div class="kpi-card kpi-normal">
                    <span class="kpi-value">#{statsGlucosaBean.estadisticas.registrosNormales}</span>
                    <span class="kpi-label">Normales</span>
                </div>
                <div class="kpi-card kpi-warning">
                    <span class="kpi-value">#{statsGlucosaBean.estadisticas.registrosAltos}</span>
                    <span class="kpi-label">Altos (>180)</span>
                </div>
                <div class="kpi-card kpi-danger">
                    <span class="kpi-value">#{statsGlucosaBean.estadisticas.registrosBajos}</span>
                    <span class="kpi-label">Bajos (&lt;70)</span>
                </div>
            </h:panelGroup>

            <!-- Gr치fico -->
            <h:panelGroup id="chartPanel" layout="block" styleClass="chart-card">
                <h3 style="margin-top: 0; color: #3058a6;">Tendencia de Niveles</h3>
                <p:lineChart model="#{statsGlucosaBean.lineChartModel}" style="width: 100%; height: 400px;" />

                <h:panelGroup id="conclusionPanel" layout="block">
                    <h:panelGroup rendered="#{statsGlucosaBean.estadisticas != null}" styleClass="conclusion-box"
                        layout="block">
                        <strong>An치lisis Autom치tico:</strong>
                        <h:outputText value=" #{statsGlucosaBean.estadisticas.conclusion}" />
                    </h:panelGroup>
                </h:panelGroup>
            </h:panelGroup>

            <!-- Tabla Detallada -->
            <h:panelGroup id="tablePanel" layout="block" styleClass="table-card">
                <h3 style="margin-top: 0; margin-bottom: 20px; color: #3058a6;">Registro Detallado de Mediciones</h3>

                <!-- Importante: prependId=false para que DataTables encuentre la tabla por ID simple -->
                <h:dataTable id="registrosTable" value="#{statsGlucosaBean.glucosaRegistros}" var="registro"
                    styleClass="display" style="width:100%">

                    <h:column>
                        <f:facet name="header">ID</f:facet>
                        #{registro.idGlucosa}
                    </h:column>

                    <h:column>
                        <f:facet name="header">Paciente</f:facet>
                        <div class="user-info">
                            <div class="user-avatar">
                                #{registro.idUsuario.nombres.substring(0,1)}
                            </div>
                            <div>
                                <strong>#{registro.idUsuario.nombres} #{registro.idUsuario.apellidos}</strong><br />
                                <small style="color: #666;">Doc: #{registro.idUsuario.documento}</small>
                            </div>
                        </div>
                    </h:column>

                    <h:column>
                        <f:facet name="header">Fecha y Hora</f:facet>
                        <h:outputText value="#{registro.fechaHora}">
                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
                        </h:outputText>
                    </h:column>

                    <h:column>
                        <f:facet name="header">Nivel (mg/dL)</f:facet>
                        <h:outputText value="#{registro.nivelGlucosa}"
                            style="font-weight: bold; font-size: 1.1em; color: #3058a6;" />
                    </h:column>

                    <h:column>
                        <f:facet name="header">Momento</f:facet>
                        #{registro.momentoDia}
                    </h:column>

                    <h:column>
                        <f:facet name="header">Estado</f:facet>
                        <ui:fragment rendered="#{registro.nivelGlucosa gt 180}">
                            <span class="badge badge-alto">ALTO</span>
                        </ui:fragment>
                        <ui:fragment rendered="#{registro.nivelGlucosa lt 70}">
                            <span class="badge badge-bajo">BAJO</span>
                        </ui:fragment>
                        <ui:fragment rendered="#{registro.nivelGlucosa ge 70 and registro.nivelGlucosa le 180}">
                            <span class="badge badge-normal">NORMAL</span>
                        </ui:fragment>
                    </h:column>

                </h:dataTable>
            </h:panelGroup>

        </h:form>
    </main>
</h:body>

</html>