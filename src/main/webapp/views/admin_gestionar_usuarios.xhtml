<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      lang="es">

<h:head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gestión de Usuarios - Control Glucosa</title>

    <h:outputStylesheet library="css" name="navbar.css"/>
    <h:outputStylesheet library="css" name="styles.css"/>
    <h:outputStylesheet library="css" name="jquery.dataTables.min.css"/>

    <h:outputScript library="js" name="jquery.dataTables.min.js"/>
    <h:outputScript library="js" name="script.js"/>

    <style>
        /* Layout base (mantener colores principales) */
        .dashboard-container { padding: 20px 30px; }
        .welcome-admin { margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid rgba(48,88,166,0.12); }

        /* Dashboard cards */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin: 18px 0 28px; }
        .dashboard-card { background: #fff; padding: 18px; border-radius: 10px; box-shadow: 0 6px 18px rgba(16,24,40,0.06); text-align: left; border-left: 6px solid #3058a6; }
        .dashboard-card h3 { margin:0 0 8px; color: #3058a6; font-size:1.05rem; }
        .dashboard-card .stat-number { font-size: 1.9rem; font-weight:700; color: #f45501; display:block; }
        .dashboard-card p { margin: 6px 0 0; color:#555; font-size:0.95rem; }
        .card-actions { margin-top:12px; display:flex; gap:10px; }
        .card-link { background-color:#3058a6; color:#fff; padding:8px 12px; border-radius:6px; text-decoration:none; display:inline-block; }
        .card-link.secondary { background:#f5f5f7; color:#3058a6; border:1px solid #e6e9f2; }

        /* Table improvements */
        .user-table { width:100%; border-collapse:collapse; margin-top:12px; background:#fff; border-radius:6px; overflow:hidden; box-shadow:0 4px 12px rgba(16,24,40,0.04); }
        .user-table th, .user-table td { padding:12px 10px; text-align:left; border-bottom:1px solid #f0f2f8; }
        .user-table thead th { background:#f7f9ff; color:#3058a6; font-weight:600; }
        .user-table tbody tr:hover { background:#fcfcfe; }

        /* Buttons */
        .edit-btn, .save-btn { padding:8px 12px; border-radius:6px; cursor:pointer; border:none; }
        .edit-btn { background-color:#f45501; color:white; }
        .save-btn { background-color:#3058a6; color:white; }
        .cancel-button { background:#e9ecef; color:#333; padding:8px 12px; border-radius:6px; border:none; }

        /* Responsive tweaks */
        @media (max-width:720px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .user-table thead { display:none; }
            .user-table td { display:block; width:100%; }
            .user-table tr { margin-bottom:10px; display:block; border:1px solid #f0f2f8; border-radius:6px; }
        }
    </style>
</h:head>

<h:body>

    <ui:include src="/includes/navbar.xhtml"/>

    <main class="dashboard-container" style="overflow-x:auto; max-width:100vw;">

        <h1 class="welcome-admin">Gestión de Usuarios</h1>
        <p>Administra y controla la información de los usuarios del sistema. Aquí puede editar los datos, asignar roles y gestionarlos forma rápida y sencilla.</p>

        <!-- (Las tarjetas fueron movidas al Panel de Inicio) -->

        <!-- Botón para abrir modal de correo -->
        <button type="button" class="edit-btn" onclick="abrirModal()">Enviar correos</button><br/><br/>

        <!-- ✅ Growl de PrimeFaces para mensajes -->
        <p:growl id="growl" showDetail="true" life="4000" />

        <!-- ✅ Tabla de usuarios -->
        <h:form id="usuariosForm">
            <h:dataTable id="usuario" value="#{dashboardAdminBean.listaUsuarios}" var="usuario" 
                         style="min-width:900px; max-width:100%;" styleClass="user-table display">

                <h:column>
                    <f:facet name="header">
                        <input type="checkbox" id="selectAll"/> Selec.
                    </f:facet>
                    <input type="checkbox" class="userCheckbox" value="#{usuario.idUsuario}"/>
                </h:column>

                <h:column>
                    <f:facet name="header">Nombre</f:facet>
                    <h:inputText value="#{usuario.nombres}" rendered="#{usuario.editable}"/>
                    <h:outputText value="#{usuario.nombres}" rendered="#{!usuario.editable}"/>
                </h:column>

                <h:column>
                    <f:facet name="header">Apellido</f:facet>
                    <h:inputText value="#{usuario.apellidos}" rendered="#{usuario.editable}"/>
                    <h:outputText value="#{usuario.apellidos}" rendered="#{!usuario.editable}"/>
                </h:column>

                <h:column>
                    <f:facet name="header">Correo</f:facet>
                    <h:inputText value="#{usuario.correo}" rendered="#{usuario.editable}"/>
                    <h:outputText value="#{usuario.correo}" rendered="#{!usuario.editable}"/>
                </h:column>

                <h:column>
                    <f:facet name="header">Usuario</f:facet>
                    <h:inputText value="#{usuario.user}" rendered="#{usuario.editable}"/>
                    <h:outputText value="#{usuario.user}" rendered="#{!usuario.editable}"/>
                </h:column>

                <h:column>
                    <f:facet name="header">Documento</f:facet>
                    <h:inputText value="#{usuario.documento}" rendered="#{usuario.editable}"/>
                    <h:outputText value="#{usuario.documento}" rendered="#{!usuario.editable}"/>
                </h:column>

                <h:column>
                    <f:facet name="header">Rol</f:facet>
                    <h:selectOneMenu value="#{usuario.nuevoRolId}" rendered="#{usuario.editable}" styleClass="role-select">
                        <f:selectItems value="#{dashboardAdminBean.listaRoles}" var="rol"
                                       itemValue="#{rol.idRol}" itemLabel="#{rol.nombre}"/>
                    </h:selectOneMenu>
                    <h:outputText value="#{usuario.rolNombre}" rendered="#{!usuario.editable}"/>
                </h:column>

                <h:column>
                    <f:facet name="header">Acciones</f:facet>
                    <h:commandButton value="Editar" action="#{dashboardAdminBean.editarUsuario(usuario)}"
                                     rendered="#{!usuario.editable}" styleClass="edit-btn"/>
                    <h:commandButton value="Guardar" action="#{dashboardAdminBean.guardarUsuario(usuario)}"
                                     rendered="#{usuario.editable}" styleClass="save-btn"/>
                </h:column>
            </h:dataTable>
        </h:form>

        <!-- ✅ Modal de envío de correo -->
        <h:form id="correoForm">
            <h:panelGroup id="correoModal" 
                          style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                                 background: rgba(0,0,0,0.5); justify-content:center; align-items:center;">

                <div style="background:white; padding:25px; border-radius:10px; width:500px; max-width:90%;
                     box-shadow:0 4px 12px rgba(0,0,0,0.2); animation:fadeIn 0.3s ease;">

                    <h2 style="margin-top:0; text-align:center;">Enviar Correo</h2>

                    <div class="form-group">
                        <h:outputLabel for="destinatarios" value="Destinatarios:"/>
                        <p:inputTextarea id="destinatarios" value="#{correoBean.destinatariosString}" 
                                         styleClass="custom-textarea" autoResize="true"/>
                        <h:inputHidden id="destinatariosHidden" value="#{correoBean.destinatariosString}" />
                    </div>

                    <div class="form-group">
                        <h:outputLabel for="asunto" value="Asunto:"/>
                        <h:inputText id="asunto" value="#{correoBean.asunto}" 
                                     styleClass="custom-input"/>
                    </div>

                    <div class="form-group">
                        <h:outputLabel for="mensaje" value="Mensaje:"/>
                        <p:inputTextarea id="mensaje" value="#{correoBean.mensaje}" 
                                         styleClass="custom-textarea" rows="6" autoResize="true"/>
                    </div>

                    <div style="margin-top:15px; display:flex; justify-content:flex-end; gap:10px;">
                        <p:commandButton value="Enviar" 
                                         actionListener="#{correoBean.enviarCorreoMasivo}" 
                                         update="growl"
                                         styleClass="ui-button-success" 
                                         icon="pi pi-send" />
                        <h:commandButton value="Cerrar" 
                                         onclick="cerrarModal();return false;" 
                                         styleClass="cancel-button"/>
                    </div>
                </div>
            </h:panelGroup>
        </h:form>
        
        <!-- Pequeños scripts para interacción del dashboard -->
        <script>
            // Select / deselect all checkboxes
            document.addEventListener('DOMContentLoaded', function(){
                var sel = document.getElementById('selectAll');
                if(sel){
                    sel.addEventListener('change', function(){
                        var checks = document.querySelectorAll('.userCheckbox');
                        checks.forEach(function(c){ c.checked = sel.checked; });
                    });
                }
            });
            function abrirModal(){ var m = document.getElementById('correoModal'); if(m) m.style.display='flex'; }
            function cerrarModal(){ var m = document.getElementById('correoModal'); if(m) m.style.display='none'; }
        </script>
    </main>
</h:body>
</html>
