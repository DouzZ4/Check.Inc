<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:p="http://primefaces.org/ui"
    xmlns:fn="http://java.sun.com/jsp/jstl/functions">

<ui:composition template="/views/TemplateSitio.xhtml">
    <ui:define name="title">Dashboard Paciente</ui:define>
    <ui:define name="content">
        <h:outputStylesheet name="css/dashboard.css" />

        <h:form id="patientDashboardForm">
            <h2 class="dashboard-title">Mi Salud - Dashboard</h2>
            <p class="dashboard-subtitle">Resumen r치pido de tu control de glucosa, anomal칤as y pr칩ximas citas.</p>

            <!-- Tarjetas resumen -->
            <div class="dashboard-cards-grid">
                <div class="card-compact card-primary">
                    <p class="card-label">칔ltima medici칩n</p>
                    <h3 class="card-value card-value-primary">
                        <h:outputText
                            value="#{not empty patientDashboardBean.glucosaReciente ? patientDashboardBean.glucosaReciente.get(0).nivelGlucosa : '-'}" />
                        <small class="card-unit"> mg/dL</small>
                    </h3>
                    <p class="card-meta">
                        <h:outputText
                            value="#{not empty patientDashboardBean.glucosaReciente ? patientDashboardBean.glucosaReciente.get(0).fechaHora : ''}">
                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
                        </h:outputText>
                    </p>
                </div>

                <div class="card-compact card-success">
                    <p class="card-label">Promedio (칰ltimos d칤as)</p>
                    <h3 class="card-value card-value-success">
                        <h:outputText value="#{patientDashboardBean.promedioGlucosa}">
                            <f:convertNumber type="number" minFractionDigits="1" maxFractionDigits="2" />
                        </h:outputText>
                        <small class="card-unit"> mg/dL</small>
                    </h3>
                    <p class="card-meta">Promedio de todos los registros</p>
                </div>

                <div class="card-compact card-warning">
                    <p class="card-label">Pr칩xima cita</p>
                    <h3 class="card-value card-value-warning">
                        <h:outputText
                            value="#{not empty patientDashboardBean.proximasCitas ? patientDashboardBean.proximasCitas.get(0).fecha : '-'}">
                            <f:convertDateTime pattern="dd/MM/yyyy" />
                        </h:outputText>
                    </h3>
                    <p class="card-meta">
                        <h:outputText
                            value="#{not empty patientDashboardBean.proximasCitas ? patientDashboardBean.proximasCitas.get(0).motivo : 'Sin citas pr칩ximas'}" />
                    </p>
                </div>

                <div class="card-compact card-purple">
                    <p class="card-label">Medicamentos</p>
                    <h3 class="card-value card-value-purple">
                        <h:outputText value="#{fn:length(patientDashboardBean.medicamentos)}" />
                    </h3>
                    <p class="card-meta">Activos</p>
                </div>
            </div>

            <!-- Gr치fico y tabla -->
            <div class="dashboard-content-grid">
                <div class="card">
                    <h3 class="section-title">Tendencia de Glucosa</h3>
                    <p:lineChart id="patientLineChart" model="#{patientDashboardBean.lineChartModel}"
                        style="max-height:320px;" />
                </div>

                <div class="card">
                    <h3 class="section-title">칔ltimas lecturas</h3>
                    <h:panelGroup rendered="#{empty patientDashboardBean.glucosaReciente}">
                        <p class="empty-state">No hay registros de glucosa disponibles.</p>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{not empty patientDashboardBean.glucosaReciente}">
                        <h:dataTable value="#{patientDashboardBean.glucosaReciente}" var="g"
                            styleClass="recent-readings-table">
                            <h:column>
                                <f:facet name="header">
                                    <div class="table-header">
                                        Fecha</div>
                                </f:facet>
                                <h:outputText value="#{g.fechaHora}">
                                    <f:convertDateTime pattern="dd/MM HH:mm" />
                                </h:outputText>
                            </h:column>
                            <h:column>
                                <f:facet name="header">
                                    <div class="table-header">
                                        Nivel</div>
                                </f:facet>
                                <h:outputText value="#{g.nivelGlucosa}" />
                            </h:column>
                            <h:column>
                                <f:facet name="header">
                                    <div class="table-header">
                                        Momento</div>
                                </f:facet>
                                <h:outputText value="#{g.momentoDia}" />
                            </h:column>
                        </h:dataTable>
                    </h:panelGroup>
                </div>
            </div>

            <!-- 游 Panel de Predicciones ML -->
            <!-- 游 Panel de Predicciones ML -->
            <h:panelGroup id="mlPanelSection">
                <!-- Case A: ML disponible con datos -->
                <h:panelGroup rendered="#{patientDashboardBean.mlDisponible}">
                    <div class="ml-panel">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 class="ml-panel-title">游댩 An치lisis Predictivo (IA)</h3>
                            <p:commandButton value="Actualizar"
                                actionListener="#{patientDashboardBean.sincronizarHistorialIA}" update="@form"
                                icon="pi pi-refresh" styleClass="ui-button-outlined ui-button-secondary ui-button-sm" />
                        </div>
                        <div class="ml-predictions-grid">
                            <!-- Nivel de Riesgo -->
                            <h:panelGroup styleClass="risk-card risk-low"
                                rendered="#{patientDashboardBean.nivelRiesgo eq 'bajo'}">
                                <p class="risk-card-label">Nivel de Riesgo Actual</p>
                                <h:outputText value="#{patientDashboardBean.nivelRiesgo}"
                                    styleClass="risk-badge risk-low" />
                                <p class="risk-score">
                                    Score: <h:outputText value="#{patientDashboardBean.riesgoScore * 100}">
                                        <f:convertNumber pattern="#0" />
                                    </h:outputText>%
                                </p>
                            </h:panelGroup>
                            <h:panelGroup styleClass="risk-card risk-medium"
                                rendered="#{patientDashboardBean.nivelRiesgo eq 'medio'}">
                                <p class="risk-card-label">Nivel de Riesgo Actual</p>
                                <h:outputText value="#{patientDashboardBean.nivelRiesgo}"
                                    styleClass="risk-badge risk-medium" />
                                <p class="risk-score">
                                    Score: <h:outputText value="#{patientDashboardBean.riesgoScore * 100}">
                                        <f:convertNumber pattern="#0" />
                                    </h:outputText>%
                                </p>
                            </h:panelGroup>
                            <h:panelGroup styleClass="risk-card risk-high"
                                rendered="#{patientDashboardBean.nivelRiesgo eq 'alto'}">
                                <p class="risk-card-label">Nivel de Riesgo Actual</p>
                                <h:outputText value="#{patientDashboardBean.nivelRiesgo}"
                                    styleClass="risk-badge risk-high" />
                                <p class="risk-score">
                                    Score: <h:outputText value="#{patientDashboardBean.riesgoScore * 100}">
                                        <f:convertNumber pattern="#0" />
                                    </h:outputText>%
                                </p>
                            </h:panelGroup>

                            <!-- Recomendaciones -->
                            <div>
                                <h4 class="recommendations-title">游눠 Recomendaciones
                                    Personalizadas</h4>
                                <h:panelGroup rendered="#{empty patientDashboardBean.recomendaciones}">
                                    <p class="recommendations-empty">No hay suficientes datos para generar
                                        recomendaciones.</p>
                                </h:panelGroup>
                                <ul class="recommendations-list">
                                    <ui:repeat value="#{patientDashboardBean.recomendaciones}" var="rec">
                                        <li class="recommendation-item">#{rec}</li>
                                    </ui:repeat>
                                </ul>
                            </div>
                        </div>
                    </div>
                </h:panelGroup>

                <!-- Case B: ML no disponible (a칰n no sincronizado o error) -->
                <h:panelGroup rendered="#{not patientDashboardBean.mlDisponible}">
                    <div class="ml-panel" style="text-align:center; padding: 30px;">
                        <h3 class="ml-panel-title" style="margin-bottom:15px;">游댩 Activar Inteligencia Artificial</h3>
                        <p style="color:#666; margin-bottom:20px;">Sincroniza tu historial m칠dico para recibir
                            predicciones personalizadas y alertas de riesgo.</p>
                        <p:commandButton value="Iniciar An치lisis IA"
                            actionListener="#{patientDashboardBean.sincronizarHistorialIA}" update="@form"
                            icon="pi pi-sparkles" styleClass="ui-button-primary" />
                    </div>
                </h:panelGroup>
            </h:panelGroup>

            <!-- Anomal칤as recientes -->
            <div class="card" style="margin-top:20px;">
                <h3 class="section-title">Anomal칤as recientes</h3>
                <h:panelGroup rendered="#{empty patientDashboardBean.anomaliasRecientes}">
                    <p class="empty-state">No hay anomal칤as registradas.</p>
                </h:panelGroup>
                <h:panelGroup rendered="#{not empty patientDashboardBean.anomaliasRecientes}">
                    <h:dataTable value="#{patientDashboardBean.anomaliasRecientes}" var="a"
                        styleClass="anomalies-table">
                        <h:column>
                            <f:facet name="header">
                                <div class="table-header">
                                    Fecha</div>
                            </f:facet>
                            <h:outputText value="#{a.fechaHora}">
                                <f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
                            </h:outputText>
                        </h:column>
                        <h:column>
                            <f:facet name="header">
                                <div class="table-header">
                                    Descripci칩n</div>
                            </f:facet>
                            <h:outputText value="#{a.descripcion}" />
                        </h:column>
                        <h:column>
                            <f:facet name="header">
                                <div class="table-header">
                                    Gravedad</div>
                            </f:facet>
                            <h:panelGroup rendered="#{a.gravedad eq 'grave'}">
                                <span class="severity-grave">#{a.gravedad}</span>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{a.gravedad eq 'moderada'}">
                                <span class="severity-moderada">#{a.gravedad}</span>
                            </h:panelGroup>
                            <h:panelGroup rendered="#{a.gravedad eq 'leve'}">
                                <span class="severity-leve">#{a.gravedad}</span>
                            </h:panelGroup>
                        </h:column>
                    </h:dataTable>
                </h:panelGroup>
            </div>

        </h:form>



    </ui:define>
</ui:composition>

</html>