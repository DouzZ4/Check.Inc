<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:p="http://primefaces.org/ui"
    xmlns:fn="http://java.sun.com/jsp/jstl/functions">

<ui:composition template="/views/TemplateSitio.xhtml">
    <ui:define name="title">Dashboard Paciente</ui:define>
    <ui:define name="content">
        <h:outputStylesheet name="css/dashboard.css" />

        <h:form id="patientDashboardForm">
            <!-- Header del Dashboard -->
            <div class="dashboard-header">
                <div>
                    <h2 class="dashboard-title">Mi Salud - Dashboard</h2>
                    <p class="dashboard-subtitle">Resumen r치pido de tu control de glucosa, anomal칤as y pr칩ximas citas.
                    </p>
                </div>
            </div>

            <!-- NUEVO: Layout Grid Principal -->
            <div class="dashboard-main-grid">

                <!-- Fila 1: Tarjetas KPI (4 columnas) -->
                <div class="grid-kpi-1 card-compact card-primary">
                    <p class="card-label">칔ltima medici칩n</p>
                    <h3 class="card-value card-value-primary">
                        <h:outputText
                            value="#{not empty patientDashboardBean.glucosaReciente ? patientDashboardBean.glucosaReciente.get(0).nivelGlucosa : '-'}" />
                        <small class="card-unit"> mg/dL</small>
                    </h3>
                    <p class="card-meta">
                        <h:outputText
                            value="#{not empty patientDashboardBean.glucosaReciente ? patientDashboardBean.glucosaReciente.get(0).fechaHora : ''}">
                            <f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
                        </h:outputText>
                    </p>
                </div>

                <div class="grid-kpi-2 card-compact card-success">
                    <p class="card-label">Promedio (칰ltimos d칤as)</p>
                    <h3 class="card-value card-value-success">
                        <h:outputText value="#{patientDashboardBean.promedioGlucosa}">
                            <f:convertNumber type="number" minFractionDigits="1" maxFractionDigits="2" />
                        </h:outputText>
                        <small class="card-unit"> mg/dL</small>
                    </h3>
                    <p class="card-meta">Promedio de todos los registros</p>
                </div>

                <div class="grid-kpi-3 card-compact card-warning">
                    <p class="card-label">Pr칩xima cita</p>
                    <h3 class="card-value card-value-warning">
                        <h:outputText
                            value="#{not empty patientDashboardBean.proximasCitas ? patientDashboardBean.proximasCitas.get(0).fecha : '-'}">
                            <f:convertDateTime pattern="dd/MM/yyyy" />
                        </h:outputText>
                    </h3>
                    <p class="card-meta">
                        <h:outputText
                            value="#{not empty patientDashboardBean.proximasCitas ? patientDashboardBean.proximasCitas.get(0).motivo : 'Sin citas pr칩ximas'}" />
                    </p>
                </div>

                <div class="grid-kpi-4 card-compact card-purple">
                    <p class="card-label">Medicamentos</p>
                    <h3 class="card-value card-value-purple">
                        <h:outputText value="#{fn:length(patientDashboardBean.medicamentos)}" />
                    </h3>
                    <p class="card-meta">Activos</p>
                </div>

                <!-- Fila 2: Gr치fico (ocupa 2 columnas) y Tabla Glucosa (2 columnas) -->
                <div class="grid-chart card">
                    <h3 class="section-title">游늳 Tendencia de Glucosa</h3>
                    <p:lineChart id="patientLineChart" model="#{patientDashboardBean.lineChartModel}"
                        style="max-height:280px;" />
                </div>

                <div class="grid-table-glucosa card">
                    <h3 class="section-title">游늵 칔ltimas lecturas</h3>
                    <h:panelGroup rendered="#{empty patientDashboardBean.glucosaReciente}">
                        <p class="empty-state">No hay registros de glucosa disponibles.</p>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{not empty patientDashboardBean.glucosaReciente}">
                        <table id="glucosaTable" class="display recent-readings-table" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Nivel (mg/dL)</th>
                                    <th>Momento</th>
                                </tr>
                            </thead>
                            <tbody>
                                <ui:repeat value="#{patientDashboardBean.glucosaReciente}" var="g">
                                    <tr>
                                        <td>
                                            <h:outputText value="#{g.fechaHora}">
                                                <f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
                                            </h:outputText>
                                        </td>
                                        <td>#{g.nivelGlucosa}</td>
                                        <td>#{g.momentoDia}</td>
                                    </tr>
                                </ui:repeat>
                            </tbody>
                        </table>
                    </h:panelGroup>
                </div>

                <!-- Fila 3: Panel ML y Anomal칤as lado a lado -->
                <div class="grid-ml" style="display:none;">
                    <!-- PANEL IA DESACTIVADO POR DEMO
                    <h:panelGroup id="mlPanelSection">
                         ... contenido ...
                    </h:panelGroup>
                    -->
                </div>

                <!-- Anomal칤as (칰ltima columna de la fila 3) -->
                <div class="grid-anomalias card">
                    <h3 class="section-title">丘멆잺 Anomal칤as recientes</h3>
                    <h:panelGroup rendered="#{empty patientDashboardBean.anomaliasRecientes}">
                        <p class="empty-state">No hay anomal칤as registradas.</p>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{not empty patientDashboardBean.anomaliasRecientes}">
                        <table id="anomaliasTable" class="display anomalies-table" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Descripci칩n</th>
                                    <th>Gravedad</th>
                                </tr>
                            </thead>
                            <tbody>
                                <ui:repeat value="#{patientDashboardBean.anomaliasRecientes}" var="a">
                                    <tr>
                                        <td>
                                            <h:outputText value="#{a.fechaHora}">
                                                <f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
                                            </h:outputText>
                                        </td>
                                        <td>#{a.descripcion}</td>
                                        <td>
                                            <h:panelGroup rendered="#{a.gravedad eq 'grave'}">
                                                <span class="severity-grave">#{a.gravedad}</span>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{a.gravedad eq 'moderada'}">
                                                <span class="severity-moderada">#{a.gravedad}</span>
                                            </h:panelGroup>
                                            <h:panelGroup rendered="#{a.gravedad eq 'leve'}">
                                                <span class="severity-leve">#{a.gravedad}</span>
                                            </h:panelGroup>
                                        </td>
                                    </tr>
                                </ui:repeat>
                            </tbody>
                        </table>
                    </h:panelGroup>
                </div>
            </div>

        </h:form>



    </ui:define>
</ui:composition>

</html>